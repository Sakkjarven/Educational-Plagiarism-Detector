name: Scheduled Plagiarism Analysis

on:
  # Запуск каждый день в 08:00 UTC
  schedule:
    - cron: '0 8 * * *'
  
  # Ручной запуск с параметрами
  workflow_dispatch:
    inputs:
      data_folder:
        description: 'Folder with sample data'
        required: true
        default: 'sample-data'
      threshold:
        description: 'Similarity threshold (0-1)'
        required: true
        default: '0.3'
      algorithms:
        description: 'Algorithms to use (comma-separated)'
        required: true
        default: 'all'

jobs:
  analyze:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 8.0.x
        
    - name: Restore dependencies
      run: dotnet restore
      
    - name: Build project
      run: dotnet build --no-restore --configuration Release
      
    - name: Run scheduled analysis
      run: |
        cd src/PlagiarismChecker.Cli
        dotnet run --no-build --configuration Release -- \
          -i "../../${{ github.event.inputs.data_folder || 'sample-data' }}" \
          -t "${{ github.event.inputs.threshold || '0.3' }}" \
          -a "${{ github.event.inputs.algorithms || 'all' }}" \
          -o "../../scheduled-results-${{ github.run_id }}.json" \
          --no-progress
      
    - name: Upload analysis results
      uses: actions/upload-artifact@v4
      with:
        name: plagiarism-analysis-${{ github.run_id }}
        path: |
          scheduled-results-*.json
          results_*.json
          
    - name: Generate summary report
      run: |
        echo "## 📊 Plagiarism Analysis Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Run ID:** ${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
        echo "**Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
        echo "**Timestamp:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ -f "scheduled-results-${{ github.run_id }}.json" ]; then
          echo "✅ Analysis completed successfully" >> $GITHUB_STEP_SUMMARY
          echo "📁 Results saved as artifact: plagiarism-analysis-${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
        else
          echo "❌ Analysis failed or no results generated" >> $GITHUB_STEP_SUMMARY
        fi